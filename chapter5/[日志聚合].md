# 日志聚合

最后，我们来谈谈日志聚合，它是运维部分必不可少的一环。由于微服务架构本质上是基于分布式系统之上的软件应用架构方式，随着服务的增多、节点的增多，登录节点、查看日志、分析日志的工作将会耗费更高的成本。通过日志聚合的方式，能有效将不同节点的日志聚合到集中的地方，便于分析和可视化。目前，业界最著名的日志聚合工具是Splunk和Logstash，其中笔者在项目中使用较多的是Splunk，Splunk是一个功能强大的日志管理工具，它不仅可以用多种方式来添加日志，生产图形化报表，最厉害的是它的搜索功能 - 被称为“Google for IT”。

这里我们就对如何配置Splunk做一简单介绍，Splunk可以单机部署，也可以分布式部署，在微服务架构中，由于不同的服务可能部署在不同的主机上，而我们希望对日志进行集中管理，因此通常使用的是分布式部署。分布式部署时，每个部署有微服务的主机上都会安装一个转发器(forwarder)，日志通过转发器被转发到Splunk服务器上，负责接收的这台Splunk实例被称作接收器，他通常也作为Splunk索引器(indexer)。

Splunk服务器配置非常简单，只需要下载相应的安装包，根据向导一步步的进行就好，安装完成后便可通过8000端口在浏览器中进行访问。我们主要介绍的是Splunk forwarder，也就是客户端的配置。

首先需要下载[Splunk Universal Forwarder](http://download.splunk.com/products/splunk/releases/6.1.1/universalforwarder/windows/splunkforwarder-6.1.1-207789-x64-release.msi)并运行，一直点击”Next”直到”Receiving Indexer”对话框，在这一页，需要配置indexer的ip地址和端口号，端口号默认为9997，填写好后继续点击”Next”直到安装完成。

配置Splunk Universal Forwarder

- 打开文件"C:\Program Files\SplunkUniversalForwarder\etc\system\local\inputs.conf”，如果你在安装时选择了其他路径，请打开对应目录下的inputs.conf。

- 在文件末尾添加以下代码：

```
  [monitor://日志路径]
  ignoreOlderThan = 10d
  disabled = 0
  followTail = 0
  index = [index name]
  sourcetype = [source type]

```

ignoreOlderThan代表忽略10天前的历史日志，也就是从近十天的日志开始转发，index和sourcetype用来在服务端对日志进行搜索，具体参数请参考[Splunk官方文档](http://docs.splunk.com/Documentation/Splunk/6.1/admin/Inputsconf)


- 在命令行执行以下命令重启服务

```
  cd "C:\Program Files\SplunkUniversalForwarder\bin"
  splunk restart
```  

- 到这里Splunk Universal Forwarder就配置完成了，但是由于服务端还没创建对应的index，所以我们需要登录服务端控制台，根据刚才在inputs.conf中设置的index name创建对应的index。这样，就可以通过浏览器访问Splunk indexer查看和搜素日志信息了。